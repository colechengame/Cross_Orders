# 跨集團會員綁定機制分析

> **版本**: v2.0 (2025.11.12)
> **目的**: 分析會員跨集團綁定的兩階段機制及優化建議

---

## 📋 目錄

1. [前置條件](#前置條件)
2. [兩階段綁定機制](#兩階段綁定機制)
3. [跨轉單專員角色](#跨轉單專員角色)
4. [系統架構分析](#系統架構分析)
5. [優化建議](#優化建議)

---

## 前置條件

### 必須完成的前置作業

> ⚠️ **重要**: 以下功能開發前，必須先完成會員帳號整併

**整併要求**:
- 一個會員在一個 BU 只能有一個帳號
- 需要清理歷史上同一人多個會員帳號的情況
- 確保會員資料的唯一性

**整併範圍**:
- BU1（板橋醫美）的會員資料
- BU3（愛美肌）的會員資料
- BU4（漾澤）的會員資料

---

## 兩階段綁定機制

### 核心概念

**綁定條件**: 姓名 + 手機號碼

當西醫與加盟店的會員資料中，姓名和手機號碼完全一致時，視為同一個會員。

---

### 第一階段：系統自動配對關聯

#### 特性

```
觸發時機：會員資料新增或更新時
比對條件：姓名 + 手機號碼
處理方式：自動關聯
資料同步：❌ 不會同步兩邊會員資料
狀態標記：「已關聯」
```

#### 運作流程

```
會員 A 在 BU3（愛美肌）註冊
  ├─ 姓名：王小美
  └─ 手機：0912-345-678

系統自動掃描其他 BU
  ↓
在 BU1（板橋醫美）找到匹配會員
  ├─ 姓名：王小美
  └─ 手機：0912-345-678
  ↓
自動建立關聯關係
  ├─ BU3 會員 ID: M-BU3-001
  ├─ BU1 會員 ID: M-BU1-001
  ├─ 關聯狀態：「已關聯」（第一階段）
  └─ 關聯時間：2025-11-12 14:30
  ↓
⚠️ 兩邊會員資料保持獨立
  ├─ BU3 會員資料可單獨異動
  ├─ BU1 會員資料可單獨異動
  └─ 異動不會相互影響
```

#### 資料結構

```typescript
interface IMemberAutoLink {
  linkId: string;                    // 關聯 ID
  linkType: 'auto';                  // 關聯類型：自動
  linkStatus: 'linked';              // 關聯狀態：已關聯
  linkDate: string;                  // 關聯時間

  // BU3 會員資訊
  bu3: {
    memberId: string;                // BU3 會員 ID
    memberName: string;              // 姓名
    phone: string;                   // 手機
    bu: string;                      // BU3
  };

  // BU1 會員資訊
  bu1: {
    memberId: string;                // BU1 會員 ID
    memberName: string;              // 姓名
    phone: string;                   // 手機
    bu: string;                      // BU1
  };

  // 匹配條件
  matchCriteria: {
    nameMatch: boolean;              // 姓名匹配
    phoneMatch: boolean;             // 手機匹配
    matchScore: number;              // 匹配分數（0-100）
  };

  // 同步設定
  syncEnabled: false;                // 不啟用同步
}
```

#### 使用場景

**適用情境**:
- ✅ 快速建立跨 BU 會員關聯
- ✅ 允許跨轉單操作
- ✅ 保持各 BU 會員資料獨立性

**限制**:
- ❌ 不會同步會員基本資料
- ❌ 不會同步會員地址、生日等個人資訊
- ❌ 不會同步會員等級、積分等業務資料

---

### 第二階段：人工驗證強綁定

#### 特性

```
觸發時機：操作者/使用者手動點選
比對條件：姓名 + 手機號碼（已通過第一階段）
處理方式：人工驗證後強制綁定
資料同步：✅ 強制同步會員資料
狀態標記：「已強綁定」
```

#### 運作流程

```
第一階段已建立關聯的會員
  ├─ BU3 會員 ID: M-BU3-001（王小美）
  └─ BU1 會員 ID: M-BU1-001（王小美）
  ↓
跨轉單專員/操作人員檢視
  ├─ 確認身份資訊（可能需要客戶提供證件）
  ├─ 確認會員資料一致性
  └─ 確認無重複帳號問題
  ↓
點選「強制綁定」按鈕
  ↓
系統執行強綁定流程
  ├─ 比對兩邊會員完整資料
  ├─ 標記差異項目（需人工決定保留哪邊資料）
  ├─ 選擇主資料來源（BU3 或 BU1）
  └─ 同步會員資料
  ↓
建立強綁定關係
  ├─ 關聯狀態：「已強綁定」（第二階段）
  ├─ 綁定操作人：張店長
  ├─ 綁定時間：2025-11-12 15:00
  └─ 啟用雙向同步
  ↓
✅ 後續異動自動同步
  ├─ BU3 會員資料異動 → 自動同步到 BU1
  └─ BU1 會員資料異動 → 自動同步到 BU3
```

#### 資料結構

```typescript
interface IMemberStrongLink {
  linkId: string;                    // 關聯 ID（沿用第一階段）
  linkType: 'strong';                // 關聯類型：強綁定
  linkStatus: 'strong-linked';       // 關聯狀態：已強綁定
  linkDate: string;                  // 原始關聯時間
  strongLinkDate: string;            // 強綁定時間

  // 操作資訊
  operator: string;                  // 操作人員
  operatorBU: string;                // 操作人員所屬 BU
  verificationMethod: string;        // 驗證方式（證件、電話、現場等）

  // 會員資訊（同第一階段）
  bu3: IMemberInfo;
  bu1: IMemberInfo;

  // 主資料來源
  masterDataSource: 'bu3' | 'bu1';   // 主資料來源

  // 同步設定
  syncEnabled: true;                 // 啟用同步
  syncFields: string[];              // 同步欄位
  syncDirection: 'bidirectional';    // 雙向同步

  // 同步歷史
  syncHistory: ISyncRecord[];        // 同步記錄
}

interface ISyncRecord {
  syncId: string;                    // 同步 ID
  syncDate: string;                  // 同步時間
  syncFrom: 'bu3' | 'bu1';           // 同步來源
  syncTo: 'bu1' | 'bu3';             // 同步目標
  syncFields: {                      // 同步欄位
    fieldName: string;
    oldValue: string;
    newValue: string;
  }[];
  syncStatus: 'success' | 'failed';  // 同步狀態
}
```

#### 使用場景

**適用情境**:
- ✅ 會員頻繁在兩個 BU 間消費
- ✅ 需要統一管理會員資料
- ✅ 確保會員資料一致性

**優點**:
- ✅ 會員資料自動同步，減少人工維護
- ✅ 保證兩邊資料一致
- ✅ 簡化跨轉單流程

**注意事項**:
- ⚠️ 強綁定後無法輕易解除
- ⚠️ 資料同步可能覆蓋現有資料
- ⚠️ 需要明確的主資料來源規則

---

## 兩階段對比

| 項目 | 第一階段（自動關聯） | 第二階段（強綁定） |
|------|---------------------|-------------------|
| **觸發方式** | 系統自動 | 人工手動 |
| **比對條件** | 姓名 + 手機 | 姓名 + 手機（已通過第一階段） |
| **資料同步** | ❌ 不同步 | ✅ 強制同步 |
| **獨立性** | 兩邊資料獨立 | 兩邊資料連動 |
| **適用場景** | 偶爾跨轉消費 | 頻繁跨轉消費 |
| **解除難度** | 容易 | 困難 |
| **風險** | 低（資料獨立） | 中（資料覆蓋風險） |

---

## 跨轉單專員角色

### 職責定位

```
┌─────────────────────────────────────────┐
│ 跨轉單專員 - 協調處理區                  │
├─────────────────────────────────────────┤
│                                          │
│ 主要業務：                               │
│ 1. 處理會員身份核對                      │
│ 2. 協調跨 BU 會員綁定                    │
│ 3. 處理異常跨轉單                        │
│ 4. 維護會員基本資料                      │
│                                          │
│ 監控與提醒：                             │
│ 1. 監控自動關聯會員數量                  │
│ 2. 提醒需要強綁定的會員                  │
│ 3. 監控跨轉單異常情況                    │
│ 4. 提醒會員資料不一致                    │
└─────────────────────────────────────────┘
```

### 詳細流程

#### 情境 1: 處理無關聯會員

```
消耗方查詢會員
  ↓
系統比對：姓名 + 手機
  ↓
結果：查無關聯
  ↓
轉交跨轉單專員處理
  ↓
跨轉單專員操作：
  ├─ 致電建檔門市外場主管
  ├─ 或透過 Line 群組聯繫加盟店員工
  ├─ 確認會員身份資料
  └─ 進行會員基本資料校正
  ↓
維護會員身份單位情境：
  ├─ 1. 建檔門市單位
  ├─ 2. 指定諮詢師所屬單位
  └─ 3. 該銷售訂單所屬單位
  ↓
手動建立關聯 or 強綁定
```

#### 情境 2: 處理部分關聯會員

```
消耗方查詢會員
  ↓
系統比對：姓名 + 手機
  ↓
結果：部分關聯（如：姓名相同但手機不同）
  ↓
轉交跨轉單專員處理
  ↓
跨轉單專員操作：
  ├─ 確認現場提供的身份資料
  ├─ 比對歷購歷消記錄
  └─ 判斷是否為同一人
  ↓
判斷結果：
  ├─ 是同一人 → 修正資料後建立關聯
  └─ 不是同一人 → 回報請客戶自行聯繫銷售門市
```

#### 情境 3: 監控與提醒

```
系統定期掃描：
  ├─ 自動關聯會員數量
  ├─ 頻繁跨轉消費的會員
  └─ 會員資料不一致情況
  ↓
生成提醒清單：
  ├─ 建議強綁定的會員（頻繁跨轉消費）
  ├─ 需要資料校正的會員（資料不一致）
  └─ 異常跨轉單（消耗數量異常、訂單異常等）
  ↓
跨轉單專員檢視並處理：
  ├─ 聯繫會員確認資料
  ├─ 執行強綁定操作
  └─ 處理異常跨轉單
```

---

## 系統架構分析

### JPOS vs NPOS

根據流程圖顯示的系統架構：

```
┌─────────────────────────────────────────┐
│ JPOS（綠色）                             │
├─────────────────────────────────────────┤
│ • 開立消耗單                             │
│ • 課程消耗記錄                           │
│ • 療程管理                               │
│ • 與跨轉單系統整合                       │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ NPOS（黃色）                             │
├─────────────────────────────────────────┤
│ • 消耗療程                               │
│ • 既有消耗介面                           │
│ • 傳統消耗流程                           │
│ • 需要手動 key 入                        │
└─────────────────────────────────────────┘
```

#### 系統特性對比

| 項目 | JPOS | NPOS |
|------|------|------|
| **用途** | 新系統，支持跨轉單 | 舊系統，傳統消耗 |
| **操作** | 自動化程度高 | 需要手動操作 |
| **跨轉單** | ✅ 原生支持 | ❌ 需返回操作 |
| **會員綁定** | ✅ 支持兩階段綁定 | ❌ 不支持 |
| **資料同步** | ✅ 實時同步 | ❌ 需手動維護 |

#### 整合方案

```
跨轉單系統模組
  ↓
跨轉單（預結單）轉移完成
  ↓
  ├─→ JPOS: 開立消耗單（推薦）✨
  │     └─ 自動記錄消耗
  │     └─ 自動更新剩餘堂數
  │     └─ 回寫 BU1 & BU3 歷購歷銷
  │
  └─→ NPOS: 返回既有消耗介面 key 此跨轉消耗療程
        └─ 手動記錄消耗
        └─ 手動更新剩餘堂數
        └─ 需人工確認同步
```

**建議**:
- ✅ 優先使用 JPOS（自動化程度高）
- ⚠️ NPOS 作為備用方案（系統異常時使用）
- 🎯 長期目標：逐步淘汰 NPOS，全面轉向 JPOS

---

## 優化建議

### 1. 會員綁定流程優化

#### 現有流程

```
手動查詢 → 發現無關聯 → 轉交專員 → 電話確認 → 手動建立關聯
```

**痛點**:
- ⏰ 耗時長（平均 5-10 分鐘）
- 👥 需要人工介入
- ❌ 依賴跨轉單專員

#### 優化方案

```
智能查詢 → 模糊匹配 → 提示相似會員 → 一鍵關聯
```

**改進點**:

##### A. 智能模糊匹配

```typescript
// 模糊匹配邏輯
interface IFuzzyMatchConfig {
  // 嚴格匹配（第一階段自動關聯）
  strict: {
    name: 'exact';        // 姓名完全一致
    phone: 'exact';       // 手機完全一致
  };

  // 模糊匹配（提示可能相同會員）
  fuzzy: {
    name: {
      similarity: 0.8;    // 姓名相似度 >= 80%
      allowTypo: true;    // 允許打字錯誤
    };
    phone: {
      lastDigits: 4;      // 手機後 4 碼一致
      allowFormat: true;  // 允許格式差異（09xx-xxx-xxx vs 09xxxxxxxx）
    };
  };

  // 推薦匹配（提示建議強綁定）
  recommend: {
    crossConsumption: 3;  // 跨轉消費次數 >= 3 次
    recentDays: 30;       // 近 30 天內
  };
}
```

##### B. 一鍵關聯功能

```
UI 設計：

┌────────────────────────────────────────┐
│ 查詢結果                                │
├────────────────────────────────────────┤
│                                         │
│ 🔍 在 BU3（愛美肌）找到相似會員：       │
│                                         │
│ ┌──────────────────────────────────┐  │
│ │ 👤 王小美                         │  │
│ │ 📱 0912-345-678                  │  │
│ │ 📍 建檔門市：愛美肌               │  │
│ │ 🎯 相似度：95%                    │  │
│ │                                   │  │
│ │ 可能原因：                        │  │
│ │ • 姓名完全相同 ✅                 │  │
│ │ • 手機號碼一致 ✅                 │  │
│ │                                   │  │
│ │    [確認是同一人] [不是同一人]   │  │
│ └──────────────────────────────────┘  │
│                                         │
│ 💡 提示：點擊「確認是同一人」將自動      │
│    建立關聯，允許跨轉單操作。            │
└────────────────────────────────────────┘
```

##### C. 自動推薦強綁定

```
系統定期分析：

每週掃描自動關聯會員
  ↓
篩選條件：
  ├─ 跨轉消費次數 >= 3 次（過去 30 天）
  ├─ 總消耗金額 >= 5000 元
  └─ 兩邊會員資料相似度 >= 90%
  ↓
生成推薦清單
  ↓
發送通知給跨轉單專員
  ↓
專員檢視並執行強綁定
```

---

### 2. 跨轉單專員工作效率優化

#### 問題分析

現有流程中，跨轉單專員需要：
- 📞 逐筆電話確認會員身份
- 💬 透過 Line 群組溝通
- 📝 手動記錄處理結果
- 🔄 重複處理相似問題

#### 優化方案

##### A. 批量處理功能

```
┌────────────────────────────────────────┐
│ 跨轉單專員工作台                        │
├────────────────────────────────────────┤
│                                         │
│ 📋 待處理清單 (15)                      │
│                                         │
│ ☐ 王小美 - BU3→BU1 - 無關聯             │
│ ☐ 李大華 - BU1→BU4 - 部分關聯           │
│ ☐ 陳小明 - BU4→BU3 - 資料不一致         │
│ ...                                     │
│                                         │
│ [全選] [批量關聯] [批量強綁定]          │
│                                         │
│ 📊 處理統計（本月）                     │
│ • 已處理：128 筆                        │
│ • 平均處理時間：3 分鐘                  │
│ • 成功率：95%                           │
└────────────────────────────────────────┘
```

##### B. 智能提示功能

```typescript
// 智能提示系統
interface ISmartSuggestion {
  // 相似案例
  similarCases: {
    caseId: string;
    similarity: number;
    solution: string;         // 之前的處理方式
    operator: string;         // 之前的處理人員
  }[];

  // 推薦操作
  recommendedAction: 'link' | 'strong-link' | 'reject';
  confidence: number;         // 推薦信心度（0-100）

  // 風險提示
  risks: {
    type: 'data-conflict' | 'duplicate-account' | 'fraud';
    severity: 'low' | 'medium' | 'high';
    description: string;
  }[];
}
```

##### C. 快速聯繫功能

```
整合通訊功能：

┌────────────────────────────────────────┐
│ 會員身份確認                            │
├────────────────────────────────────────┤
│                                         │
│ 需要確認的會員：王小美                  │
│ 建檔門市：愛美肌 BU3                    │
│                                         │
│ 快速聯繫：                              │
│ [📞 撥打電話] [💬 Line 訊息] [📧 Email]│
│                                         │
│ 常用話術模板：                          │
│ ┌──────────────────────────────────┐  │
│ │ 您好，這裡是板橋醫美。               │  │
│ │ 我們想確認您是否也在愛美肌有          │  │
│ │ 會員資料，以便為您提供更好的          │  │
│ │ 跨店服務...                          │  │
│ └──────────────────────────────────┘  │
│                                         │
│        [使用此模板] [自訂內容]          │
└────────────────────────────────────────┘
```

---

### 3. 資料同步機制優化

#### 強綁定後的同步邏輯

##### 同步欄位設定

```typescript
// 可同步的欄位配置
interface ISyncFieldConfig {
  // 基本資料（建議同步）
  basicInfo: {
    name: { sync: true, priority: 'high' };
    phone: { sync: true, priority: 'high' };
    email: { sync: true, priority: 'medium' };
    birthday: { sync: true, priority: 'medium' };
    gender: { sync: true, priority: 'low' };
    address: { sync: false, priority: 'low' };  // 可能不同地址
  };

  // 業務資料（不建議同步）
  businessInfo: {
    memberLevel: { sync: false };     // 各 BU 獨立等級
    points: { sync: false };          // 各 BU 獨立積分
    consultant: { sync: false };      // 各 BU 獨立諮詢師
  };

  // 偏好設定（可選同步）
  preferences: {
    communication: { sync: true };    // 通訊偏好
    marketing: { sync: true };        // 行銷偏好
    privacy: { sync: true };          // 隱私設定
  };
}
```

##### 衝突處理規則

```typescript
// 當兩邊資料不一致時的處理規則
interface IConflictResolution {
  // 規則 1：時間優先（最新的資料優先）
  timeBasedRule: {
    enabled: true;
    description: '使用最近更新的資料';
  };

  // 規則 2：來源優先（指定 BU 的資料優先）
  sourceBasedRule: {
    enabled: true;
    masterSource: 'bu3' | 'bu1';  // 主資料來源
    description: '以主資料來源為準';
  };

  // 規則 3：人工確認（需要人工選擇）
  manualReviewRule: {
    enabled: true;
    conflictFields: ['email', 'address'];  // 需要人工確認的欄位
    description: '特定欄位衝突時需人工確認';
  };
}
```

##### 同步失敗處理

```
同步流程：

BU3 會員資料異動（電話更新）
  ↓
觸發同步機制
  ↓
同步到 BU1
  ├─ 成功 → 記錄同步日誌
  └─ 失敗 → 處理流程：
      ├─ 記錄錯誤日誌
      ├─ 加入重試佇列（最多重試 3 次）
      ├─ 發送通知給跨轉單專員
      └─ 標記為「同步失敗」狀態
  ↓
跨轉單專員檢視失敗原因
  ├─ 網路問題 → 手動重試
  ├─ 資料衝突 → 人工決定保留哪邊資料
  └─ 系統異常 → 聯繫 IT 處理
```

---

### 4. 完整優化流程圖

```
【優化後的會員查詢與綁定流程】

Step 1: 消耗方輸入會員資訊
  ├─ 姓名：王小美
  └─ 手機：0912-345-678
  ↓
Step 2: 系統智能搜尋
  ├─ 嚴格匹配（姓名 + 手機完全一致）
  ├─ 模糊匹配（姓名或手機相似）
  └─ 顯示搜尋結果
  ↓
Step 3: 搜尋結果處理
  ├─ 情況 A：找到完全匹配（已自動關聯）
  │   └─→ 直接進入消耗流程 ✅
  │
  ├─ 情況 B：找到相似會員（未關聯）
  │   ├─ 顯示相似度
  │   ├─ 提供「一鍵關聯」按鈕
  │   └─→ 點擊後進入消耗流程 ✅
  │
  └─ 情況 C：查無相似會員
      ├─ 選項 1：請客戶自行聯繫銷售門市
      └─ 選項 2：轉交跨轉單專員處理
          └─→ 專員協助建立關聯 ✅
  ↓
Step 4: 系統定期分析
  ├─ 識別頻繁跨轉消費的會員
  ├─ 推薦強綁定
  └─ 通知跨轉單專員
  ↓
Step 5: 專員執行強綁定（可選）
  ├─ 選擇主資料來源
  ├─ 設定同步欄位
  ├─ 處理資料衝突
  └─ 啟用雙向同步
  ↓
✅ 完成：後續消耗自動同步，無需重複綁定
```

---

## 實施建議

### 階段 1: 會員帳號整併（Week 1-2）

**必要前置作業**:
1. ✅ 掃描各 BU 重複會員帳號
2. ✅ 合併同一人的多個帳號
3. ✅ 確保一人一帳號原則

### 階段 2: 第一階段自動關聯（Week 3-4）

**開發內容**:
1. ✅ 實現姓名 + 手機自動比對
2. ✅ 建立會員關聯資料表
3. ✅ 實現智能模糊匹配
4. ✅ 實現一鍵關聯功能

### 階段 3: 跨轉單專員工作台（Week 5-6）

**開發內容**:
1. ✅ 待處理清單
2. ✅ 批量處理功能
3. ✅ 智能提示功能
4. ✅ 快速聯繫功能

### 階段 4: 第二階段強綁定（Week 7-8）

**開發內容**:
1. ✅ 強綁定操作介面
2. ✅ 資料同步機制
3. ✅ 衝突處理邏輯
4. ✅ 同步失敗處理

### 階段 5: 系統整合與優化（Week 9-10）

**整合內容**:
1. ✅ 與 JPOS 系統整合
2. ✅ 與 NPOS 系統整合（作為備用）
3. ✅ 完整測試與優化
4. ✅ 使用者培訓

---

## 預期效果

| 指標 | 現狀 | 優化後 | 改善 |
|------|------|--------|------|
| **會員查詢時間** | 5-10 分鐘 | 30 秒 | ⬇️ 90% |
| **人工介入率** | 30% | 5% | ⬇️ 83% |
| **綁定準確率** | 85% | 98% | ⬆️ 15% |
| **專員工作量** | 100% | 30% | ⬇️ 70% |
| **用戶體驗** | ⭐⭐ | ⭐⭐⭐⭐⭐ | +150% |

---

## 總結

兩階段綁定機制設計良好，兼顧了效率和準確性：

- **第一階段（自動關聯）**: 快速建立關聯，滿足大部分跨轉需求
- **第二階段（強綁定）**: 深度整合會員資料，提供更好的服務體驗

通過優化建議的實施，可以大幅減少人工介入，提升系統自動化程度，同時保證資料準確性和安全性。
